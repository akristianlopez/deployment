services:
  app:
    image: kristian2022/knb-shell:1.0 # Assurez-vous que l'image correspond à votre tag local
    networks:
      - public_net
    environment:
      # UTILISEZ LE NOM DU SERVICE DEFINI DANS LA STACK INFRA
      - PORT=6500
      - CONSUL_ADDR=http://consul-server:8500
      - CONFIG_PATH=knb/services/shell
      - SERVICE_NAME=app
      - SERVICE_KIND=swarm
      - SERVICE_DOMAIN=wosa.local
    healthcheck:
      # Le test de santé s'adapte dynamiquement au port configuré
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:6500/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
      # Les labels Traefik sont retirés car le service s'enregistre dynamiquement 
      # dans le catalogue Consul avec ses propres tags/metadata.

networks:
  public_net:
    external: true
    name: public_net # <--- Force la connexion au réseau global existant
