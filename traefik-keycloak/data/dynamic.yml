http:
  routers:
    # Accès direct à Keycloak pour l'interface d'admin
    keycloak-router:
      rule: "Host(`auth.wosa.local`)"
      service: keycloak-service
      entryPoints:
        - websecure
      tls: {}

    traefik-dashboard:
      rule: "Host(`traefik.wosa.local`)"
      service: api@internal
      entryPoints: 
        - websecure
      middlewares:
        - oidc-auth-middleware
      tls: {}

    consul-ui:
      rule: "Host(`consul.wosa.local`)"
      service: consul-service
      entryPoints:
        - websecure
      tls: {}
      middlewares:
        - oidc-auth-middleware

    nats-router:
      rule: "Host(`nats.wosa.local`)"
      service: nats-service
      entryPoints:
        - websecure
      tls: {}
      middlewares:
        - oidc-auth-middleware


  middlewares:
    oidc-auth-middleware:
      plugin:
        oidc: # Le nom doit correspondre à celui dans traefik.yml
          # Bloc Provider : MAJUSCULES OBLIGATOIRES
          Provider:
            Url: 'http://keycloak:8080/realms/knb-cloud'
            ClientId: 'knb-client'
            ClientSecret: 'Wq43hJSO60mtHQ47GjHJeg9ZXktlJZPT'
            InsecureSkipVerify: true

          # Configuration de redirection
          # RedirectUrl: 'https://app.wosa.local/'
          # RedirectUrl: 'https://traefik.wosa.local/oidc/callback'
          
          # Secret : Chaîne de 32 caractères pour sécuriser les cookies de session
          Secret: 'VhkZTRZEmSeGbeZnInDokck1aO2r_hvf'
          
          # Options additionnelles (respectez les majuscules)
          CookieName: 'wosa-session'
          InsecureSkipVerify: true
          Scopes: ["openid", "profile", "email"]

  services:
    keycloak-service:
      loadBalancer:
        servers:
          - url: "http://keycloak:8080"

    consul-service:
      loadBalancer:
        servers:
          - url: "http://consul:8500"

    nats-service:
      loadBalancer:
        servers:
          - url: "http://nats:8222"

# --- SECTION TLS ---
tls:
  options:
    default:
      minVersion: VersionTLS12
  certificates:
    - certFile: /etc/traefik/certs/wosa.local.crt
      keyFile: /etc/traefik/certs/wosa.local.key